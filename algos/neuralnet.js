var brain = require("brain"),
    fs = require("fs"),
    path = require("path");

var dir = "train";

var netJSON = trainNetwork();
console.log("network:", JSON.stringify(netJSON));

const NET = {"layers":[{"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"16":{},"20":{},"24":{},"tabs":{}},{"0":{"bias":-1.5708766968419257,"weights":{"1":0.8298714320609255,"2":4.457758663821837,"3":5.0146934084436605,"4":1.2162715497009764,"5":1.3096220595955308,"6":3.062139292600843,"8":-1.4558207323660306,"9":0.0679050931371999,"10":-0.3077823001928604,"11":0.5800127011909728,"12":0.1640210959903658,"13":0.14507877338918726,"14":0.0225651922036262,"16":-0.03711479255202476,"20":0.15730554696225413,"24":0.03941983324058767,"tabs":4.116272662393992}},"1":{"bias":-1.2065760330794546,"weights":{"1":-0.20001909004467164,"2":-4.770073095900636,"3":-1.9702032121230377,"4":2.0372321115002685,"5":1.0594611745217752,"6":-3.294390448884011,"8":5.69276869014122,"9":-0.0822670954734742,"10":1.827249173616179,"11":0.7800314565528134,"12":3.3742947901316014,"13":0.331815896697485,"14":-0.1284384449801078,"16":2.6439166050707823,"20":1.7157032092439188,"24":0.2507425914175193,"tabs":3.20782934764324}},"2":{"bias":0.15919440949197952,"weights":{"1":-2.1662853049913777,"2":4.331857788380854,"3":-0.4133339976640195,"4":0.1829576473182779,"5":-2.1433001931116102,"6":2.5694276123481092,"8":-0.24922535789113878,"9":-0.12160546798620761,"10":-0.6351850978907619,"11":-1.3876343008697887,"12":-0.8165224423081278,"13":-0.589675587539065,"14":0.29349103352561046,"16":-0.2115645916053435,"20":0.008571025161617368,"24":0.0724266602890495,"tabs":-3.6231847312121603}},"3":{"bias":0.05401113682218354,"weights":{"1":-0.25630081163055995,"2":-0.42849677168875516,"3":3.0932895212157225,"4":-0.5478982285013553,"5":1.0366743769146483,"6":-0.3520153804410491,"8":-1.5150388856467472,"9":0.010816879651234866,"10":-0.12577365511353267,"11":0.727987604011999,"12":-0.7279882342919048,"13":0.07481650256407833,"14":0.11703047498256514,"16":-0.6156554251596398,"20":-0.5599421740439905,"24":0.10695895757563574,"tabs":2.9045820447621744}},"4":{"bias":0.9980523231542635,"weights":{"1":-2.518519966754846,"2":-5.202803723699856,"3":-1.7769587334109198,"4":-3.3675543794198863,"5":0.6436010664655775,"6":-3.3219574543446173,"8":-1.5229129111564683,"9":-0.1559151301874452,"10":0.12270703309377738,"11":0.6040094217714264,"12":-1.589768478573044,"13":0.25175085808136205,"14":-0.46196814746059933,"16":-1.740987188009835,"20":-1.0911194457095992,"24":-0.2622168925678693,"tabs":1.6070290230688082}},"5":{"bias":0.6761807645310869,"weights":{"1":-1.2684666056070806,"2":4.3301008417064715,"3":-3.1354668803699255,"4":-2.373214795917456,"5":-1.5534403842994626,"6":2.3812468601941537,"8":-3.759889537857334,"9":-0.1509047507815731,"10":-1.268759898305883,"11":-0.9470951854831722,"12":-2.718699896825031,"13":-0.17427099905245078,"14":0.10534459554920962,"16":-1.8192740830252527,"20":-1.3132257025021021,"24":-0.4087025051695527,"tabs":0.3280912563091777}},"6":{"bias":-1.1998132349160013,"weights":{"1":0.07556484724935592,"2":5.795270996943514,"3":-3.7807177349411383,"4":1.7339400556600058,"5":-0.7974014865442889,"6":3.2854147240412463,"8":2.1319658817435214,"9":0.1594170818917544,"10":0.36812558244220883,"11":-0.7568763805810458,"12":1.7535491633458948,"13":-0.3716921396044318,"14":0.17337443412380377,"16":1.9387256301127942,"20":1.085136110580153,"24":-0.008533923940473385,"tabs":-2.228444388515718}},"7":{"bias":-0.6719531366048316,"weights":{"1":0.5856502489834671,"2":3.318077961493686,"3":-1.4316646524522443,"4":-0.6623349891615233,"5":1.5157695438703251,"6":1.4785584407282064,"8":-0.9277412082824116,"9":-0.0903489609832622,"10":-0.2058406735627796,"11":0.6302479235963381,"12":0.3368111239436287,"13":0.34578297325346813,"14":-0.01072425977916052,"16":-0.054004983576348954,"20":-0.11556468082193903,"24":-0.06912744818930364,"tabs":4.476099058891346}}},{"0":{"bias":0.7830581273639626,"weights":{"0":-6.7365024354239305,"1":-4.352591049390177,"2":1.3218580186412558,"3":-0.8505502613014796,"4":5.745003914776776,"5":3.687044915879107,"6":-3.597133340963005,"7":-3.3671668431874275}},"1":{"bias":-0.0066305922373714075,"weights":{"0":-0.6088543625281618,"1":-1.2968568996768306,"2":-2.086049055127538,"3":-0.1091661851648279,"4":-1.1644332353065467,"5":-0.43724057850959763,"6":-0.9380752735684526,"7":-0.17023999926108957}},"2":{"bias":-3.463638408706465,"weights":{"0":1.794085899299141,"1":-7.1711271360722595,"2":3.2729203351760514,"3":-2.277533104263155,"4":-6.07303227239157,"5":3.9685286063097425,"6":4.501579674239241,"7":1.2248693566533333}},"3":{"bias":0.654337071477104,"weights":{"0":3.452242170779728,"1":-2.6502452365344875,"2":0.10119177801190071,"3":2.3032048548789397,"4":-2.7744942706165503,"5":-3.4083219300609207,"6":-4.350072625842256,"7":-3.9481830470842487}},"4":{"bias":1.2716896740757415,"weights":{"0":-4.8556660569880625,"1":7.677796343790829,"2":0.03740528095968852,"3":-3.4095647900301334,"4":-1.3474658617326671,"5":-5.350653425812788,"6":2.613230329717128,"7":-3.3867268526810954}},"tabs":{"bias":-1.827527737522854,"weights":{"0":0.09047521265264573,"1":1.6719947103755266,"2":-6.1854930519553815,"3":1.8025058784119719,"4":3.380982377543749,"5":-2.8757006419333493,"6":-5.527849971616105,"7":1.5129898644094766}}}],"outputLookup":true,"inputLookup":true};

module.exports = function(lines) {
  var spaces = getWidthCounts(lines);

  var net = new brain.NeuralNetwork().fromJSON(NET);
  var result = net.run(spaces);

  console.log("result:", result);

  var maxProb = 0, bestIndent = null;
  for (var width in result) {
    var prob = result[width];
    if (prob > maxProb) {
      bestIndent = width;
      maxProb = prob;
    }
  }
  if (bestIndent == 0) {
    return null;
  }
  console.log("best:", bestIndent);
  return bestIndent;
}


function trainNetwork() {
  var data = [];
  var files = fs.readdirSync(dir);

  for (var j in files) {
    var file = path.join(dir, files[j]);
    var indent = getIndent(file);
    var contents = fs.readFileSync(file, { encoding: "utf-8"});
    var lines = contents.split("\n");

    var counts = getWidthCounts(lines);
    var output = {};
    output[indent] = 1;
    console.log("input", counts);
    console.log("output", output);
    data.push({input: counts, output: output});
  }

  console.log("training network");

  var net = new brain.NeuralNetwork({learningRate: 0.1});
  var stats = net.train(data);

  console.log("trained", stats);

  return net.toJSON();
}

function getWidthCounts(lines) {
  var widths = {};  // # spaces -> # lines with that many spaces
  var total = 0;    // # of indented lines

  // count up number of lines using each type of indentation
  lines.forEach(function (text) {
    if (text[0] == "\t") {
      widths["tabs"] = (widths["tabs"] || 0) + 1;
      total++;
      return;
    }
    var i = 0;
    while (text[i] === " ") {
      i++;
    }
    if (i == 0 || i == text.length) {
      return;
    }
    widths[i] = (widths[i] || 0) + 1;
    total++;
  });

  for (var width in widths) {
    widths[width] = widths[width] / total;
  }
  // TODO divide by total to normalize btw 0 and 1
  return widths;
}

function getIndent(filename) {
  if (/-tabs\./.test(filename)) {
    return "tabs";
  }

  var matches = filename.match(/-(\d)\./);
  if (!matches) {
    return 0;
  }
  var spaces = parseInt(matches[1] || "0");
  return spaces || 0;
}
